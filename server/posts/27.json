{"id":27,"title":"WebAuthn 使用经验","content":"{\"type\":\"doc\",\"content\":[{\"type\":\"heading\",\"attrs\":{\"level\":2,\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"基本原理\"}]},{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"WebAuthn 全称为 Web Authentication API，它可以彻底干掉非常容易泄漏的密码。WebAuthn 的基础是非对称加密，有公钥和私钥之分，其中公钥由客户端传给服务器保存在数据库中，私钥则存储在用户端的认证器中，这就相当于，原来是用户的大脑记住了密码，但是现在有一个认证器，帮助我们记住了一个超级复杂的密码。它的注册的基本流程如下：\"}]},{\"type\":\"ordered_list\",\"attrs\":{\"order\":1},\"content\":[{\"type\":\"list_item\",\"content\":[{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"浏览器调用 navigator.credentials.create 获取公钥\"}]}]},{\"type\":\"list_item\",\"content\":[{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"认证器响应第一步的API调用，生成一对密钥（公钥和私钥），其中私钥就保存在认证器中，公钥返回给浏览器\"}]}]},{\"type\":\"list_item\",\"content\":[{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"获取到公钥后，把公钥传给服务器，服务器保存以供后续验证\"}]}]}]},{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"上述过程省略了很多细节，比如传给 navigator.credentials.create 的参数需要在服务器上生成，参数中包含了网站的域名和用户ID等信息，所以密钥对是平台用户维度的，这些信息也会存储在认证器中。另外把公钥传给服务器这一过程，传递的不仅仅是公钥，还有签名信息，服务器需要进行安全校验。\"}]},{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"注册后，用户登录时的基本流程如下:\"}]},{\"type\":\"ordered_list\",\"attrs\":{\"order\":1},\"content\":[{\"type\":\"list_item\",\"content\":[{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"浏览器调用 navigator.credentials.get 进行密钥认证\"}]}]},{\"type\":\"list_item\",\"content\":[{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"认证器根据传入的参数进行密钥认证，并返回认证结果\"}]}]},{\"type\":\"list_item\",\"content\":[{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"把结果回传给服务器，服务器根据传入参数和服务端之前存储的公钥进行验证，验证成功即为登录成功\"}]}]}]},{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"上述的登录过程也省略了细节，比如说 navigator.credentials.get 需要的参数也是需要在服务器上生成的，参数中可以包含之前已注册过的保存在服务器上的公钥ID，由认证器进行检索，但是在一般的多用户网站中不会如此做，因为未登录的情况下，不知当前用户，也就无法获取到当前用户的所有公钥ID。如果在第一步的参数中未传入 allowCredentials 或传入了空数组，则在返回的认证结果中，会返回 userHandle 字段，即注册时的 userId 字段，在第三步就可以根据此字段，获取到当前是哪个用户登录了。如果在第一步的参数中传入了 allowCredentials ，则不会在认证结果中返回 userHandle ，真是奇怪的特性。\"}]},{\"type\":\"heading\",\"attrs\":{\"level\":2,\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"使用方式\"}]},{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"WebAuthn 虽然只提供了 navigator.credentials.create 和 navigator.credentials.get 两个API，看上去似乎很方便调用，然而其中的参数生成和结果校验颇为复杂，所以自行开发的行为并不明智，推荐使用 SimpleWebAuthn 这个库来接入 WebAuthn 。\"}]},{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"SimpleWebAuthn 分为三个包，分别是浏览器环境中使用的 @simplewebauthn/browser、node server 环境中使用的 @simplewebauthn/server 和 在使用 typescript 开发时的辅助包 @simplewebauthn/types。浏览器环境下，提供了 startRegistration 和 startAuthentication 这两个API，分别对浏览器提供的两个API进行了封装，这两个API接收的参数分别是来自服务端的包中的 generateRegistrationOptions 和 generateAuthenticationOptions 两个方法的返回值，而 startRegistration 和 startAuthentication 这两个方法的返回值，需要分别作为服务端包中的 verifyRegisterationResponse 和 verifyAuthenticationResponse 两个方法的参数传入以校验。它们的关系图如下:\"}]},{\"type\":\"excalidraw\",\"attrs\":{\"content\":\"{\\\"elements\\\":[{\\\"type\\\":\\\"rectangle\\\",\\\"version\\\":314,\\\"versionNonce\\\":176535057,\\\"isDeleted\\\":false,\\\"id\\\":\\\"_obKxDqwclhn_1LHGRo1I\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"dashed\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":545.8380805149736,\\\"y\\\":-123.6253662109375,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"#b2f2bb\\\",\\\"width\\\":337.84972551397084,\\\"height\\\":721.9765625000001,\\\"seed\\\":1874399046,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[{\\\"type\\\":\\\"text\\\",\\\"id\\\":\\\"EtgG47bkEFYRHALiEWaW1\\\"}],\\\"updated\\\":1725947498146,\\\"link\\\":null,\\\"locked\\\":false},{\\\"type\\\":\\\"text\\\",\\\"version\\\":325,\\\"versionNonce\\\":359058417,\\\"isDeleted\\\":false,\\\"id\\\":\\\"EtgG47bkEFYRHALiEWaW1\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"dashed\\\",\\\"roughness\\\":1,\\\"opacity\\\":50,\\\"angle\\\":0,\\\"x\\\":696.085552219713,\\\"y\\\":-118.6253662109375,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"#b2f2bb\\\",\\\"width\\\":37.35478210449219,\\\"height\\\":17.159531484424907,\\\"seed\\\":780825478,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947498146,\\\"link\\\":null,\\\"locked\\\":false,\\\"fontSize\\\":13.727625187539925,\\\"fontFamily\\\":1,\\\"text\\\":\\\"server\\\",\\\"textAlign\\\":\\\"center\\\",\\\"verticalAlign\\\":\\\"top\\\",\\\"containerId\\\":\\\"_obKxDqwclhn_1LHGRo1I\\\",\\\"originalText\\\":\\\"server\\\",\\\"lineHeight\\\":1.25,\\\"baseline\\\":14},{\\\"type\\\":\\\"rectangle\\\",\\\"version\\\":418,\\\"versionNonce\\\":1733134993,\\\"isDeleted\\\":false,\\\"id\\\":\\\"v_aR5zCUluF-iO5PS4tGJ\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"dashed\\\",\\\"roughness\\\":1,\\\"opacity\\\":50,\\\"angle\\\":0,\\\"x\\\":250.1484375,\\\"y\\\":-4.22183884728463,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"#a5d8ff\\\",\\\"width\\\":276.8449099100459,\\\"height\\\":534.7151316458301,\\\"seed\\\":1020327322,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[{\\\"type\\\":\\\"text\\\",\\\"id\\\":\\\"-gJaqjnLzbWuGqYplGa_r\\\"}],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false},{\\\"type\\\":\\\"text\\\",\\\"version\\\":532,\\\"versionNonce\\\":591401073,\\\"isDeleted\\\":false,\\\"id\\\":\\\"-gJaqjnLzbWuGqYplGa_r\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":50,\\\"angle\\\":0,\\\"x\\\":354.2709275502378,\\\"y\\\":0.77816115271537,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"#a5d8ff\\\",\\\"width\\\":68.59992980957031,\\\"height\\\":17.159531484424907,\\\"seed\\\":1510883994,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false,\\\"fontSize\\\":13.727625187539925,\\\"fontFamily\\\":1,\\\"text\\\":\\\"浏览器环境\\\",\\\"textAlign\\\":\\\"center\\\",\\\"verticalAlign\\\":\\\"top\\\",\\\"containerId\\\":\\\"v_aR5zCUluF-iO5PS4tGJ\\\",\\\"originalText\\\":\\\"浏览器环境\\\",\\\"lineHeight\\\":1.25,\\\"baseline\\\":14},{\\\"type\\\":\\\"rectangle\\\",\\\"version\\\":300,\\\"versionNonce\\\":782686801,\\\"isDeleted\\\":false,\\\"id\\\":\\\"9jxCvV3nGl4tzgolkUMpX\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":619.8988045142346,\\\"y\\\":-82.94361934855385,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":194.05017049769572,\\\"height\\\":56.63449742898551,\\\"seed\\\":323624538,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":{\\\"type\\\":3},\\\"boundElements\\\":[{\\\"type\\\":\\\"text\\\",\\\"id\\\":\\\"XIeauxNWYgi99FQhxwcSn\\\"}],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false},{\\\"type\\\":\\\"text\\\",\\\"version\\\":435,\\\"versionNonce\\\":442066993,\\\"isDeleted\\\":false,\\\"id\\\":\\\"XIeauxNWYgi99FQhxwcSn\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":627.261673576559,\\\"y\\\":-63.20613637627355,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":179.32443237304688,\\\"height\\\":17.159531484424907,\\\"seed\\\":735547802,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false,\\\"fontSize\\\":13.727625187539925,\\\"fontFamily\\\":1,\\\"text\\\":\\\"generateRegistrationOPtions\\\",\\\"textAlign\\\":\\\"center\\\",\\\"verticalAlign\\\":\\\"middle\\\",\\\"containerId\\\":\\\"9jxCvV3nGl4tzgolkUMpX\\\",\\\"originalText\\\":\\\"generateRegistrationOPtions\\\",\\\"lineHeight\\\":1.25,\\\"baseline\\\":14},{\\\"type\\\":\\\"text\\\",\\\"version\\\":3,\\\"versionNonce\\\":1454438874,\\\"isDeleted\\\":true,\\\"id\\\":\\\"1NgBPzbVWSLvHr8TJ8AQf\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":909.9609375,\\\"y\\\":229.1875,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":7.8125,\\\"height\\\":25,\\\"seed\\\":422595482,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947091457,\\\"link\\\":null,\\\"locked\\\":false,\\\"fontSize\\\":20,\\\"fontFamily\\\":1,\\\"text\\\":\\\"\\\",\\\"textAlign\\\":\\\"left\\\",\\\"verticalAlign\\\":\\\"top\\\",\\\"containerId\\\":null,\\\"originalText\\\":\\\"\\\",\\\"lineHeight\\\":1.25,\\\"baseline\\\":20},{\\\"type\\\":\\\"text\\\",\\\"version\\\":2,\\\"versionNonce\\\":648205958,\\\"isDeleted\\\":true,\\\"id\\\":\\\"mAuB3RNk4wMqmDN9sQ8wK\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":895.9609375,\\\"y\\\":634.1875,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":7.8125,\\\"height\\\":25,\\\"seed\\\":909287430,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947092763,\\\"link\\\":null,\\\"locked\\\":false,\\\"fontSize\\\":20,\\\"fontFamily\\\":1,\\\"text\\\":\\\"\\\",\\\"textAlign\\\":\\\"left\\\",\\\"verticalAlign\\\":\\\"top\\\",\\\"containerId\\\":null,\\\"originalText\\\":\\\"\\\",\\\"lineHeight\\\":1.25,\\\"baseline\\\":20},{\\\"type\\\":\\\"rectangle\\\",\\\"version\\\":395,\\\"versionNonce\\\":1883191825,\\\"isDeleted\\\":false,\\\"id\\\":\\\"kfCGFYi4hd93wWx4fyPDF\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":621.3479805716302,\\\"y\\\":158.46551745775741,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":194.05017049769572,\\\"height\\\":56.63449742898551,\\\"seed\\\":1685754074,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":{\\\"type\\\":3},\\\"boundElements\\\":[{\\\"type\\\":\\\"text\\\",\\\"id\\\":\\\"M9517VQcnZ5ntMzyzjolB\\\"},{\\\"id\\\":\\\"CmfACBjwmpHy6Sg6Qan0t\\\",\\\"type\\\":\\\"arrow\\\"}],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false},{\\\"type\\\":\\\"text\\\",\\\"version\\\":569,\\\"versionNonce\\\":290443249,\\\"isDeleted\\\":false,\\\"id\\\":\\\"M9517VQcnZ5ntMzyzjolB\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":633.628078332685,\\\"y\\\":178.20300043003772,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":169.48997497558594,\\\"height\\\":17.159531484424907,\\\"seed\\\":1533502874,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false,\\\"fontSize\\\":13.727625187539925,\\\"fontFamily\\\":1,\\\"text\\\":\\\"verifyRegistrationResponse\\\",\\\"textAlign\\\":\\\"center\\\",\\\"verticalAlign\\\":\\\"middle\\\",\\\"containerId\\\":\\\"kfCGFYi4hd93wWx4fyPDF\\\",\\\"originalText\\\":\\\"verifyRegistrationResponse\\\",\\\"lineHeight\\\":1.25,\\\"baseline\\\":14},{\\\"type\\\":\\\"ellipse\\\",\\\"version\\\":334,\\\"versionNonce\\\":1612662705,\\\"isDeleted\\\":false,\\\"id\\\":\\\"XaypSxXfBPBA-TMmJohvw\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":309.04316696669963,\\\"y\\\":29.56350236592175,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":179.15623340457375,\\\"height\\\":81.58820985485154,\\\"seed\\\":1046882586,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":{\\\"type\\\":2},\\\"boundElements\\\":[{\\\"type\\\":\\\"text\\\",\\\"id\\\":\\\"znZZbl61CfgUQLVv6NPHV\\\"},{\\\"id\\\":\\\"E2KtIvQX2i1TERgZvPA8v\\\",\\\"type\\\":\\\"arrow\\\"},{\\\"id\\\":\\\"CmfACBjwmpHy6Sg6Qan0t\\\",\\\"type\\\":\\\"arrow\\\"}],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false},{\\\"type\\\":\\\"text\\\",\\\"version\\\":444,\\\"versionNonce\\\":1360865681,\\\"isDeleted\\\":false,\\\"id\\\":\\\"znZZbl61CfgUQLVv6NPHV\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":342.7745959209459,\\\"y\\\":61.9320533245168,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":112.01078796386719,\\\"height\\\":17.159531484424907,\\\"seed\\\":2001861658,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false,\\\"fontSize\\\":13.727625187539925,\\\"fontFamily\\\":1,\\\"text\\\":\\\"startRegistration\\\",\\\"textAlign\\\":\\\"center\\\",\\\"verticalAlign\\\":\\\"middle\\\",\\\"containerId\\\":\\\"XaypSxXfBPBA-TMmJohvw\\\",\\\"originalText\\\":\\\"startRegistration\\\",\\\"lineHeight\\\":1.25,\\\"baseline\\\":14},{\\\"type\\\":\\\"rectangle\\\",\\\"version\\\":384,\\\"versionNonce\\\":439969585,\\\"isDeleted\\\":false,\\\"id\\\":\\\"HGsHwIi8XYdUuPpgNt2_b\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":617.6311992403357,\\\"y\\\":305.9452389847278,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":212.43499977718034,\\\"height\\\":56.63449742898551,\\\"seed\\\":805711494,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":{\\\"type\\\":3},\\\"boundElements\\\":[{\\\"type\\\":\\\"text\\\",\\\"id\\\":\\\"pqUnGqZWhtYXW0uhxoJ0A\\\"}],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false},{\\\"type\\\":\\\"text\\\",\\\"version\\\":572,\\\"versionNonce\\\":298277137,\\\"isDeleted\\\":false,\\\"id\\\":\\\"pqUnGqZWhtYXW0uhxoJ0A\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":627.138898408711,\\\"y\\\":325.6827219570081,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":193.4196014404297,\\\"height\\\":17.159531484424907,\\\"seed\\\":495611334,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false,\\\"fontSize\\\":13.727625187539925,\\\"fontFamily\\\":1,\\\"text\\\":\\\"generateAuthenticationOPtions\\\",\\\"textAlign\\\":\\\"center\\\",\\\"verticalAlign\\\":\\\"middle\\\",\\\"containerId\\\":\\\"HGsHwIi8XYdUuPpgNt2_b\\\",\\\"originalText\\\":\\\"generateAuthenticationOPtions\\\",\\\"lineHeight\\\":1.25,\\\"baseline\\\":14},{\\\"type\\\":\\\"rectangle\\\",\\\"version\\\":459,\\\"versionNonce\\\":712773361,\\\"isDeleted\\\":false,\\\"id\\\":\\\"nKUBl8WgSLsd_sjSA-mwb\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":627.8853598906769,\\\"y\\\":525.2453919440753,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":194.05017049769572,\\\"height\\\":56.63449742898551,\\\"seed\\\":650429702,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":{\\\"type\\\":3},\\\"boundElements\\\":[{\\\"type\\\":\\\"text\\\",\\\"id\\\":\\\"6kbX7dnMnyXt2vegxTmCw\\\"},{\\\"id\\\":\\\"6NcB1Cuw1n0yIFwREC42B\\\",\\\"type\\\":\\\"arrow\\\"}],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false},{\\\"type\\\":\\\"text\\\",\\\"version\\\":659,\\\"versionNonce\\\":450824401,\\\"isDeleted\\\":false,\\\"id\\\":\\\"6kbX7dnMnyXt2vegxTmCw\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":633.1178731180404,\\\"y\\\":544.9828749163556,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":183.58514404296875,\\\"height\\\":17.159531484424907,\\\"seed\\\":489829446,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false,\\\"fontSize\\\":13.727625187539925,\\\"fontFamily\\\":1,\\\"text\\\":\\\"verifyAuthenticationResponse\\\",\\\"textAlign\\\":\\\"center\\\",\\\"verticalAlign\\\":\\\"middle\\\",\\\"containerId\\\":\\\"nKUBl8WgSLsd_sjSA-mwb\\\",\\\"originalText\\\":\\\"verifyAuthenticationResponse\\\",\\\"lineHeight\\\":1.25,\\\"baseline\\\":14},{\\\"type\\\":\\\"ellipse\\\",\\\"version\\\":421,\\\"versionNonce\\\":1243465873,\\\"isDeleted\\\":false,\\\"id\\\":\\\"qeKVpMW35ODAmh5oHK5ee\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":301.34349750726255,\\\"y\\\":389.48492661205853,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":193.8249516469627,\\\"height\\\":81.58820985485154,\\\"seed\\\":447724422,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":{\\\"type\\\":2},\\\"boundElements\\\":[{\\\"type\\\":\\\"text\\\",\\\"id\\\":\\\"cM8w1o-vgvY0aHqM3P7vm\\\"},{\\\"id\\\":\\\"Sf0On60_M1uPHq2S23di4\\\",\\\"type\\\":\\\"arrow\\\"},{\\\"id\\\":\\\"6NcB1Cuw1n0yIFwREC42B\\\",\\\"type\\\":\\\"arrow\\\"}],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false},{\\\"type\\\":\\\"text\\\",\\\"version\\\":582,\\\"versionNonce\\\":2102955633,\\\"isDeleted\\\":false,\\\"id\\\":\\\"cM8w1o-vgvY0aHqM3P7vm\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":100,\\\"angle\\\":0,\\\"x\\\":335.1755259787579,\\\"y\\\":421.8534775706536,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"transparent\\\",\\\"width\\\":126.10595703125,\\\"height\\\":17.159531484424907,\\\"seed\\\":1970952902,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947481045,\\\"link\\\":null,\\\"locked\\\":false,\\\"fontSize\\\":13.727625187539925,\\\"fontFamily\\\":1,\\\"text\\\":\\\"startAuthentication\\\",\\\"textAlign\\\":\\\"center\\\",\\\"verticalAlign\\\":\\\"middle\\\",\\\"containerId\\\":\\\"qeKVpMW35ODAmh5oHK5ee\\\",\\\"originalText\\\":\\\"startAuthentication\\\",\\\"lineHeight\\\":1.25,\\\"baseline\\\":14},{\\\"type\\\":\\\"arrow\\\",\\\"version\\\":438,\\\"versionNonce\\\":996759039,\\\"isDeleted\\\":false,\\\"id\\\":\\\"E2KtIvQX2i1TERgZvPA8v\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":50,\\\"angle\\\":0,\\\"x\\\":620.1427916025286,\\\"y\\\":-53.508152337229376,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"#b2f2bb\\\",\\\"width\\\":146.25551295998346,\\\"height\\\":99.86579206255851,\\\"seed\\\":840702598,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947481214,\\\"link\\\":null,\\\"locked\\\":false,\\\"startBinding\\\":null,\\\"endBinding\\\":{\\\"elementId\\\":\\\"XaypSxXfBPBA-TMmJohvw\\\",\\\"focus\\\":0.37258548833626975,\\\"gap\\\":1.5458727749873304},\\\"lastCommittedPoint\\\":null,\\\"startArrowhead\\\":null,\\\"endArrowhead\\\":\\\"arrow\\\",\\\"points\\\":[[0,0],[-146.25551295998346,99.86579206255851]]},{\\\"type\\\":\\\"arrow\\\",\\\"version\\\":565,\\\"versionNonce\\\":169681471,\\\"isDeleted\\\":false,\\\"id\\\":\\\"CmfACBjwmpHy6Sg6Qan0t\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":50,\\\"angle\\\":0,\\\"x\\\":473.55481272003453,\\\"y\\\":94.62954673245201,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"#b2f2bb\\\",\\\"width\\\":145.71659642430075,\\\"height\\\":94.55438083277011,\\\"seed\\\":45067610,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947481214,\\\"link\\\":null,\\\"locked\\\":false,\\\"startBinding\\\":{\\\"elementId\\\":\\\"XaypSxXfBPBA-TMmJohvw\\\",\\\"focus\\\":-0.34292074449527454,\\\"gap\\\":1.5855716067952983},\\\"endBinding\\\":{\\\"elementId\\\":\\\"kfCGFYi4hd93wWx4fyPDF\\\",\\\"focus\\\":-0.7308318280201701,\\\"gap\\\":2.07657142729488},\\\"lastCommittedPoint\\\":null,\\\"startArrowhead\\\":null,\\\"endArrowhead\\\":\\\"arrow\\\",\\\"points\\\":[[0,0],[145.71659642430075,94.55438083277011]]},{\\\"type\\\":\\\"arrow\\\",\\\"version\\\":373,\\\"versionNonce\\\":2078048863,\\\"isDeleted\\\":false,\\\"id\\\":\\\"Sf0On60_M1uPHq2S23di4\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":50,\\\"angle\\\":0,\\\"x\\\":617.9844442830033,\\\"y\\\":334.70479808352854,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"#b2f2bb\\\",\\\"width\\\":139.36220742147464,\\\"height\\\":71.71879807451278,\\\"seed\\\":1880994694,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947481214,\\\"link\\\":null,\\\"locked\\\":false,\\\"startBinding\\\":null,\\\"endBinding\\\":{\\\"elementId\\\":\\\"qeKVpMW35ODAmh5oHK5ee\\\",\\\"focus\\\":0.27164670527813467,\\\"gap\\\":1},\\\"lastCommittedPoint\\\":null,\\\"startArrowhead\\\":null,\\\"endArrowhead\\\":\\\"arrow\\\",\\\"points\\\":[[0,0],[-139.36220742147464,71.71879807451278]]},{\\\"type\\\":\\\"arrow\\\",\\\"version\\\":530,\\\"versionNonce\\\":1513666207,\\\"isDeleted\\\":false,\\\"id\\\":\\\"6NcB1Cuw1n0yIFwREC42B\\\",\\\"fillStyle\\\":\\\"solid\\\",\\\"strokeWidth\\\":2,\\\"strokeStyle\\\":\\\"solid\\\",\\\"roughness\\\":1,\\\"opacity\\\":50,\\\"angle\\\":0,\\\"x\\\":472.65125614030774,\\\"y\\\":457.7547258876218,\\\"strokeColor\\\":\\\"#1e1e1e\\\",\\\"backgroundColor\\\":\\\"#b2f2bb\\\",\\\"width\\\":154.5617986691629,\\\"height\\\":91.36109927059042,\\\"seed\\\":1679079322,\\\"groupIds\\\":[],\\\"frameId\\\":null,\\\"roundness\\\":null,\\\"boundElements\\\":[],\\\"updated\\\":1725947481215,\\\"link\\\":null,\\\"locked\\\":false,\\\"startBinding\\\":{\\\"elementId\\\":\\\"qeKVpMW35ODAmh5oHK5ee\\\",\\\"focus\\\":-0.23461100514328834,\\\"gap\\\":1.1916277950321472},\\\"endBinding\\\":{\\\"elementId\\\":\\\"nKUBl8WgSLsd_sjSA-mwb\\\",\\\"focus\\\":-0.6221872457787596,\\\"gap\\\":1},\\\"lastCommittedPoint\\\":null,\\\"startArrowhead\\\":null,\\\"endArrowhead\\\":\\\"arrow\\\",\\\"points\\\":[[0,0],[154.5617986691629,91.36109927059042]]}],\\\"files\\\":{},\\\"appState\\\":{\\\"gridSize\\\":null,\\\"viewBackgroundColor\\\":\\\"#ffffff\\\"}}\",\"align\":\"center\",\"size\":57}},{\"type\":\"heading\",\"attrs\":{\"level\":2,\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"SimpleWebAuthn 的坑\"}]},{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"SimpleWebAuthn 已经很好用了，但是在实际调用过程中，发现在格式上有些问题，需要留意处理。\"}]},{\"type\":\"heading\",\"attrs\":{\"level\":3,\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"Base64编/解码\"}]},{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"首先是 verifyRegisterationResponse 返回的结果中，公钥和密钥ID需要存储到数据库中，但是这两个字段的类型的 Uint8Array, 需要进行 base64url 编码后再保存到数据库。其次是 generateRegisterationOptions 的参数字段 excludeCredentials 和 generateAuthenticationOptions 的参数字段 allowCredentials 的 id 需要是 Uint8Array, 所以就需要在从数据库中取出之后，进行 base64url 解码。最后是 verifyAuthenticationResponse 的参数中 credentialID 和 credentialPublicKey 也需要是 Uint8Array 类型，所以也需要注意 base64url 解码。\"},{\"type\":\"text\",\"marks\":[{\"type\":\"strong\"}],\"text\":\"注意：base64url 与 base64 有一些不同\"},{\"type\":\"text\",\"text\":\" \"}]},{\"type\":\"heading\",\"attrs\":{\"level\":3,\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"userVerification 的问题\"}]},{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"在 generateRegisterationOptions 和 generateAuthenticationOptions 方法的参数中，都有一个参数叫 userVerification，这个参数的似乎是用来设置认证器行为的，可以要求认证器是否进行用户认证，有三个值，分别如下：\"}]},{\"type\":\"ordered_list\",\"attrs\":{\"order\":1},\"content\":[{\"type\":\"list_item\",\"content\":[{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"discouraged：要求认证器不要进行用户认证，因为不需要用户执行认证流程，所以对用户没有打扰，但是我理解相对的，也就会有安全方面的风险。\"}]}]},{\"type\":\"list_item\",\"content\":[{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"preferred: 期望认证器进行用户认证，如果认证器不进行认证，也会成功，但是不会设置认证标志位。\"}]}]},{\"type\":\"list_item\",\"content\":[{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"required: 期望认证器进行用户认证，如果认证器无法进行认证，则操作会失败\"}]}]}]},{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"},\"content\":[{\"type\":\"text\",\"text\":\"推荐的设置是 preferred，这样就需要在调用 verifyRegisterationResponse 或 verifyAuthenticationResponse 时，传入参数 requireUserVerification: false, 不进行 userVerfication 的校验。\"}]},{\"type\":\"paragraph\",\"attrs\":{\"align\":\"left\"}}]}","path":"/1/12","nextId":33,"createdAt":"2024-08-10T12:10:23.231Z","updatedAt":"2024-09-10T05:53:31.695Z","deleted":false,"deletedAt":null,"attributes":[{"docId":27,"key":"share","value":"48VIcsBN5ct"}]}